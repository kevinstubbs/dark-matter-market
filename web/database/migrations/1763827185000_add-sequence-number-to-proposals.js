/* eslint-disable camelcase */

exports.shorthands = undefined;

exports.up = pgm => {
  // Add sequence_number column
  // This comes from HCS (Hedera Consensus Service) message sequence numbers
  // It's nullable because existing proposals may not have sequence numbers yet
  pgm.addColumn('proposals', {
    sequence_number: {
      type: 'integer',
      notNull: false, // Nullable - comes from HCS messages, not generated by us
    },
  });

  // Create unique constraint on (dmm_id, sequence_number)
  // Using a partial unique index to only enforce uniqueness when sequence_number is NOT NULL
  // This allows multiple NULL values per DMM (for proposals without HCS sequence numbers yet)
  pgm.sql(`
    CREATE UNIQUE INDEX proposals_dmm_id_sequence_number_unique 
    ON proposals (dmm_id, sequence_number) 
    WHERE sequence_number IS NOT NULL
  `);

  // Create index for better query performance
  pgm.createIndex('proposals', ['dmm_id', 'sequence_number']);
};

exports.down = pgm => {
  pgm.dropIndex('proposals', ['dmm_id', 'sequence_number']);
  pgm.sql('DROP INDEX IF EXISTS proposals_dmm_id_sequence_number_unique');
  pgm.dropColumn('proposals', 'sequence_number');
};

